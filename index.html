<!DOCTYPE html>
<html>
<head>
    <title>Leaflet Image</title>
    <link rel="stylesheet" href="libs/leaflet/leaflet.css" />
    <script src="libs/leaflet/leaflet.js"></script>
    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
        }
        #map {
            height: 100%;
            width: 100%;
            background: black; /* Set the background color to black */
        }
        .leaflet-popup-content-wrapper {
            background: url('assets/backgrounds/wxnn.jpg') center; /* 自定义背景图片 */
            background-size: cover;
        }
        .leaflet-popup-tip {
            background-color: #f6efdd;
        }
        .leaflet-tooltip {
            background-color: #f6efdd;
            border: 2px solid #f6efdd;
        }
        .leaflet-tooltip-tip {
            background-color: #f6efdd;
        }
        .popup-content {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .popup-content img {
            max-width: 100px;
            max-height: 100px;
            margin-bottom: 10px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
        }
        .popup-content .text {
            font-size: 14px;
            color: #333;
            text-align: center;
            margin-bottom: 10px;
        }
        .popup-content button {
            padding: 5px 10px;
            background-color: #ffadd2; /* 粉色背景 */
            border: none;
            color: white;
            border-radius: 20px; /* 圆角按钮 */
            cursor: pointer;
            font-size: 14px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }
        .popup-content button:hover {
            background-color: #ff69b4; /* 深粉色背景 */
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <button id="saveButton">保存数据</button>

    <script>
        // 假设你的图片是 32768x32768 像素
        var imageWidth = 32768;
        var imageHeight = 32768;

        // 使用简单坐标系统，并设置图片的边界
        var map = L.map('map', {
            crs: L.CRS.Simple,
            minZoom: 2,
            maxZoom: 7
        });

        // 定义图片的边界（左上角和右下角）
        var southWest = map.unproject([0, imageHeight], map.getMaxZoom());
        var northEast = map.unproject([imageWidth, 0], map.getMaxZoom());
        var bounds = new L.LatLngBounds(southWest, northEast);

        // 设置地图视图为图片的中间
        map.setView([imageHeight / 2, imageWidth / 2], 2);

        // 加载瓦片
        L.tileLayer('assets/tiles/{z}/{x}/{y}.jpg', {
            maxZoom: 7,
            tileSize: 256,
            zoomOffset: 0,
            attribution: 'Image data &copy; Your Attribution',
            updateWhenIdle: true, // 仅在地图视图稳定时更新瓦片 
            updateWhenZooming: true, // 在缩放过程中不更新瓦片
            keepBuffer: 2,
            bounds: bounds
        }).addTo(map);

        // 设置地图边界
        map.setMaxBounds(bounds);

        // 创建自定义图标
        var customIcon = L.icon({
            iconUrl: 'assets/1.png', // 确认此路径正确
            iconSize: [32, 32], // 图标尺寸
            iconAnchor: [16, 32], // 图标锚点（图标底部的点）
            popupAnchor: [0, -32] // 弹出框相对于图标的位置
        });

        // 存储所有标记的数组
        var markers = [];

        var markersData = [];

        // 加载已保存的标记
        function loadMarkers() {
            $.get('/markers', function(savedMarkers) {
                savedMarkers.forEach(function(markerData) {
                    var marker = L.marker([markerData.lat, markerData.lng], { icon: customIcon }).addTo(map)
                        .bindPopup(`
                            <div class="popup-content">
                                <img src="${markerData.imageUrl}" alt="Image">
                                <div class="text"><h3>${markerData.text}</h3></div>
                                <button onclick="removeMarker(${markers.length})">删除标记</button>
                            </div>`)
                        .bindTooltip(markerData.text); // 绑定工具提示
                    markers.push(marker);
                });
            });
        }

        // 保存标记到服务器
        function saveMarkers() {
            var markerData = markers.map(marker => {
                if (marker) {
                    var popupContent = marker.getPopup().getContent();
                    var imageUrl = $(popupContent).find('img').attr('src');
                    var text = $(popupContent).find('.text').text();
                    return { lat: marker.getLatLng().lat, lng: marker.getLatLng().lng, imageUrl: imageUrl, text: text };
                }
                return null;
            }).filter(marker => marker !== null);

            $.post('/markers', JSON.stringify(markerData), null, 'json');
        }

        // 在地图上添加标记并记录坐标和弹出框信息
        map.on('contextmenu', function(e) {
            var latlng = e.latlng;
            var imageUrl = prompt("请输入图片URL：");
            var text = prompt("请输入文字信息：");
            var marker = L.marker([latlng.lat, latlng.lng], { icon: customIcon }).addTo(map)
                .bindPopup(`
                    <div class="popup-content">
                        <img src="${imageUrl}" alt="Image">
                        <div class="text"><h3>${text}</h3></div>
                        <div class="text">标记位置：纬度 ${latlng.lat.toFixed(2)}, 经度 ${latlng.lng.toFixed(2)}</div>
                        <button onclick="removeMarker(${markers.length})">删除标记</button>
                    </div>`)
                .bindTooltip(text, { direction: 'right', offset: [16, -16] }) // 绑定工具提示
                .openPopup();

            var markerData = {
                lat: latlng.lat, lng: latlng.lng, imageUrl: imageUrl, text: text
            };
            markersData.push(markerData);

            // 存储标记到数组中
            markers.push(marker);

        });


        // 删除标记的函数
        function removeMarker(index) {
            if (markers[index]) {
                map.removeLayer(markers[index]);
                markers[index] = null; // 标记为null以防止重复删除

            }
        }

        document.getElementById('saveButton').addEventListener('click', function() {
            var jsonData = JSON.stringify(markersData);
    
            var blob = new Blob([jsonData], { type: "application/json" });
            var url = URL.createObjectURL(blob);
    
            var a = document.createElement('a');
            a.href = url;
            a.download = 'data.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        });

    </script>
</body>
</html>
